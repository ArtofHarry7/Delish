{% extends 'base.html' %}
{% load static %}

{% block title %}Popular{% endblock title %}

{% block style %}
<style>
</style>
{% endblock style %}

{% block body %}
<!-- <section>
    <div class="sidepanel">
        <h1>Hello</h1>
    </div>
</section> -->

<section class="popular" id="popular">

    <h1 class="heading"> most <span>popular</span> foods </h1>
    <div class="menu_body">
        <!-- <div class="panel">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" role="switch" id="veg">
                <label class="form-check-label ml-2" for="veg" value="veg">
                  Veg
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" role="switch" id="nonveg">
                <label class="form-check-label ml-2" for="nonveg">
                  Non-Veg
                </label>
              </div>
        </div> -->
        <div class="menu_content">
            <div class="box-container" id="items">
            
                {% for i in pop_menu %}
                <!-- {% if i.veg %} -->
                <div class="box">
                    <span class="price"> Rs.{{i.price}} </span>
                        <img src='/media/{{i.image}}' alt="">
                            <h3 id="namem{{i.id}}">{{i.name}}
                                {{i.veg}}
                            </h3>
                                <!-- <div class="stars">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="far fa-star"></i>
                                </div> -->
                            <span id="divm{{i.id}}" class="divm">
                        <button id="m{{i.id}}" class="btn btn-primary cart">Add To Cart</button>
                    </span>
                </div>
                <!-- {% endif %} -->
                {% endfor %}

            </div>
        </div>
    </div>

</section>
{% endblock body %}

{% block jss %}

<script>
// find out the items from card storage
let fstr = `<a id="popcart" class="btn btn-secondary mx-4 my-2 my-sm-0" data-html="true" data-container="body"
          data-toggle="popover" data-placement="bottom">
          Cart(<span id="cart">0</span>)
        </a>`

document.getElementById("form").innerHTML = fstr + document.getElementById("form").innerHTML;

// fstr = ``;
// console.log('{{pop_menu}}'.name);
// for(name in '{{pop_menu}}'){
//     console.log(name);
// }
// let ele = document.getElementById('veg');
// if(ele.checked == true){
//     console.log('yeeeeeeeeeeeeee');
// }

if(localStorage.getItem('cart') == null){
    var cart = {};
}
else{
    cart = JSON.parse(localStorage.getItem('cart'));
    document.getElementById('cart').innerHTML = Object.keys(cart).length;
    updateCart(cart);
}
let kardo = true;

//if add to card is clicked, add incriment the item
$('.cart').click(function(){
    // console.log('clicked');
    var idstr = this.id.toString();
    console.log(idstr);
    if (cart[idstr] != undefined){
        qty = cart[idstr][0] + 1;
        cart[idstr] = [qty, name];
    }
    else{
        qty = 1;
        name = document.getElementById('name'+idstr).innerHTML;
        cart[idstr] = [qty, name];
    }
    updateCart(cart);
    updatePopover(cart);
});

//add popover to the card
updatePopover(cart);
function updatePopover(cart){
    // console.log('test');
    var popStr = "";
    popStr = popStr + "<h5> Cart items </h5>";
    var i = 1;
    for (var item in cart){
        popStr = popStr + "<b>" + i + ". </b>";
        popStr = popStr + document.getElementById('name' + item).innerHTML + " : " + cart[item][0] + '<br>';
        i = i + 1;
    }
    popStr = popStr + "<a href='/checkout'><button class='btn btn-primary' id='checkout'>Checkout</button></a>";
    document.getElementById('popcart').setAttribute('data-content', popStr);
    $('#popcart').popover('show');
}

function updateCart(cart){
    var sum = 0;
    for (var item in cart){
        sum = sum + cart[item][0];
        document.getElementById('div'+item).innerHTML = "<button id='minus" + item+ "' class='btn btn-primary minus'>-</button> <span id='val" + item + "''>" + cart[item][0] + "</span> <button id='plus" + item + "' class='btn btn-primary plus'> + </button>";
    }
    localStorage.setItem('cart', JSON.stringify(cart));
    document.getElementById('cart').innerHTML = sum;
    console.log(cart);
    updatePopover(cart);
}

//plus or minus
$('.divm').on("click", "button.minus", function(){
    a = this.id.slice(6, );
        if ('m'+a in cart){
        cart['m'+a][0] = cart['m'+a][0]-1;
        cart['m'+a][0] = Math.max(0, cart['m'+a][0])
        document.getElementById('valm'+a).innerHTML = cart['m'+a][0];
        
        if (cart['m'+a][0] == 0){
            delete cart['m'+a]
        }
        updateCart(cart);
        updatePopover(cart);
    }
});

$('.divm').on("click", "button.plus", function(){
    a = this.id.slice(5, );
    if ('m'+a in cart){
        cart['m'+a][0] = cart['m'+a][0]+1;
        document.getElementById('valm'+a).innerHTML = cart['m'+a][0];
    }
    else{
        qty = 1
        name = document.getElementById('name'+'m'+a).innerHTML;
        cart['m'+a] = [qty, name];
    }
    updateCart(cart);
    updatePopover(cart);
});

</script>
{% endblock jss %}